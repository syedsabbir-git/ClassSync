// src/components/dashboard/StudyHelper/StudyHelperPage.jsx - Production Ready
import React, { useState, useEffect } from 'react';
import { Sparkles, Play, FileText, Target, AlertCircle, CheckCircle } from 'lucide-react';
import { useAuth } from '../../../contexts/AuthContext';
import activityService from '../../../services/dashboard/activityService';
import studyHelperService from '../../../services/studyHelperService';
import LoadingSpinner from '../Shared/LoadingSpinner';

const StudyHelperPage = () => {
  const { userData } = useAuth();
  const [activeTab, setActiveTab] = useState('tasks');
  const [selectedTask, setSelectedTask] = useState(null);
  const [tasks, setTasks] = useState([]);
  const [resources, setResources] = useState({ videos: [], resources: [] });
  const [studyPlan, setStudyPlan] = useState(null);
  const [loadingTasks, setLoadingTasks] = useState(true);
  const [loadingResources, setLoadingResources] = useState(false);
  const [error, setError] = useState(null);

  // Fetch all tasks for this student
  // eslint-disable-next-line react-hooks/exhaustive-deps
  useEffect(() => {
    if (userData?.uid) {
      fetchStudentTasks();
    }
  }, [userData?.uid]);

  const fetchStudentTasks = async () => {
    try {
      setLoadingTasks(true);
      setError(null);
      
      console.log('ðŸ“š StudyHelper: User role:', userData?.role);
      
      // For CRs, use managedSections; for students, use enrolledSections
      const sections = userData?.role === 'cr' 
        ? (userData?.managedSections || [])
        : (userData?.enrolledSections || []);
      
      if (!sections || sections.length === 0) {
        console.log('âš ï¸ No sections found');
        setError('No sections found. Please make sure you have sections to manage or enroll in.');
        setTasks([]);
        setLoadingTasks(false);
        return;
      }

      let allTasks = [];

      for (const sectionId of sections) {
        try {
          const result = await activityService.getActivitiesBySection(sectionId);
          
          // Handle both array and object responses
          let sectionActivities = Array.isArray(result) ? result : (result?.activities || []);
          
          if (!Array.isArray(sectionActivities)) {
            console.warn(`âš ï¸ Could not extract activities array for ${sectionId}`);
            continue;
          }
          
          const now = new Date();
          
          const upcomingTasks = sectionActivities
            .filter(activity => {
              if (!activity) return false;
              const dueDate = activity.dueDate?.toDate?.() || new Date(activity.dueDate);
              return dueDate > now;
            })
            .map(activity => {
              const dueDate = activity.dueDate?.toDate?.() || new Date(activity.dueDate);
              const daysLeft = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
              return {
                ...activity,
                daysLeft: Math.max(0, daysLeft),
                sectionId,
                dueDate
              };
            });

          allTasks = [...allTasks, ...upcomingTasks];
        } catch (err) {
          console.error(`Error fetching activities for section ${sectionId}:`, err);
        }
      }

      // Sort by due date (nearest first)
      allTasks.sort((a, b) => a.dueDate - b.dueDate);

      setTasks(allTasks);
    } catch (err) {
      console.error('Error fetching tasks:', err);
      setError('Failed to load tasks. Please try again.');
    } finally {
      setLoadingTasks(false);
    }
  };

  const handleSelectTask = async (task) => {
    setSelectedTask(task);
    setLoadingResources(true);
    setActiveTab('plan');
    setError(null);

    try {
      // Generate study plan using Gemini AI
      const plan = await studyHelperService.generateStudyPlan(
        task.title,
        task.description,
        task.daysLeft,
        task.type
      );
      setStudyPlan(plan);

      // Fetch YouTube videos
      const videos = await studyHelperService.getYoutubeVideos(task.title);

      // Get AI-recommended resources
      const aiResources = await studyHelperService.generateResourceRecommendations(
        task.title,
        task.description,
        task.type
      );

      setResources({
        videos: videos || [],
        resources: aiResources || []
      });

      // Switch to resources tab after loading
      setActiveTab('resources');
    } catch (err) {
      console.error('Error generating plan:', err);
      setError('Failed to generate study materials. Please try again.');
      setActiveTab('plan');
    } finally {
      setLoadingResources(false);
    }
  };


  return (
    <div className="min-h-screen bg-gray-50 p-4 md:p-8">
      {/* Header */}
      <div className="mb-8">
        <div className="flex items-center gap-3 mb-2">
          <div className="p-3 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg">
            <Sparkles className="w-6 h-6 text-white" />
          </div>
          <h1 className="text-3xl font-bold text-gray-900">AI Study Helper</h1>
        </div>
        <p className="text-gray-600">Select a task to get personalized study materials</p>
      </div>

      {/* Error Display */}
      {error && (
        <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
          <AlertCircle className="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0" />
          <div>
            <p className="text-red-700 font-medium">Error</p>
            <p className="text-red-600 text-sm">{error}</p>
          </div>
        </div>
      )}

      {/* Tab Navigation */}
      <div className="mb-8 border-b border-gray-200">
        <div className="flex gap-4 overflow-x-auto">
          {[
            { id: 'tasks', label: 'My Tasks', icon: 'ðŸ“‹' },
            { id: 'resources', label: 'Resources', icon: 'ðŸ“š', disabled: !selectedTask },
            { id: 'plan', label: 'Study Plan', icon: 'ðŸ“', disabled: !studyPlan }
          ].map((tab) => (
            <button
              key={tab.id}
              onClick={() => !tab.disabled && setActiveTab(tab.id)}
              disabled={tab.disabled}
              className={`pb-3 px-4 font-medium flex items-center gap-2 border-b-2 whitespace-nowrap transition-colors ${
                activeTab === tab.id
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-600 hover:text-gray-900 disabled:opacity-50 disabled:cursor-not-allowed'
              }`}
            >
              <span>{tab.icon}</span>
              {tab.label}
            </button>
          ))}
        </div>
      </div>

      {/* Tab Content */}
      <div>
        {/* Tasks Tab */}
        {activeTab === 'tasks' && (
          <div>
            {loadingTasks ? (
              <LoadingSpinner />
            ) : tasks.length > 0 ? (
              <div className="space-y-3">
                {tasks.map((task) => (
                  <div
                    key={task.id}
                    className={`p-4 rounded-lg border-2 transition-all cursor-pointer ${
                      selectedTask?.id === task.id
                        ? 'border-blue-500 bg-blue-50'
                        : 'border-gray-200 bg-white hover:border-gray-300'
                    }`}
                    onClick={() => handleSelectTask(task)}
                  >
                    <div className="flex justify-between items-start mb-2">
                      <div className="flex-1">
                        <h3 className="font-bold text-gray-900">{task.title}</h3>
                        <p className="text-sm text-gray-600 mt-1">{task.description?.substring(0, 100)}...</p>
                      </div>
                      <div className="text-right ml-4">
                        <span className="inline-block px-3 py-1 text-sm font-medium text-white bg-gradient-to-r from-orange-500 to-orange-600 rounded-full">
                          {task.daysLeft === 0 ? 'Today' : task.daysLeft === 1 ? 'Tomorrow' : `${task.daysLeft}d left`}
                        </span>
                      </div>
                    </div>

                    <div className="flex gap-2 text-sm text-gray-500">
                      <span className="px-2 py-1 bg-gray-100 rounded">Type: {task.type}</span>
                      <span className="px-2 py-1 bg-gray-100 rounded">
                        Due: {task.dueDate?.toLocaleDateString?.() || new Date(task.dueDate).toLocaleDateString()}
                      </span>
                    </div>

                    {selectedTask?.id === task.id && (
                      <div className="mt-3 text-blue-600 text-sm font-medium">
                        {loadingResources ? 'Loading study materials...' : 'âœ“ Click to generate study plan'}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-white rounded-lg p-12 text-center text-gray-500">
                <Sparkles className="w-12 h-12 mx-auto mb-3 opacity-30" />
                <p>No upcoming tasks. You're all caught up! ðŸŽ‰</p>
              </div>
            )}
          </div>
        )}

        {/* Resources Tab */}
        {activeTab === 'resources' && (
          <div>
            {loadingResources ? (
              <LoadingSpinner />
            ) : selectedTask ? (
              <div className="space-y-8">
                {/* YouTube Videos */}
                {resources.videos && resources.videos.length > 0 && (
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <Play className="w-5 h-5 text-blue-600" />
                      Video Tutorials
                    </h3>
                    <div className="grid md:grid-cols-2 gap-4">
                      {resources.videos.map((video, idx) => (
                        <a
                          key={idx}
                          href={video.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow"
                        >
                          <div className="bg-gray-200 h-40 flex items-center justify-center">
                            <Play className="w-12 h-12 text-gray-400" />
                          </div>
                          <div className="p-4">
                            <h4 className="font-bold text-gray-900 line-clamp-2">{video.title}</h4>
                            {video.channel && <p className="text-sm text-gray-600 mt-1">{video.channel}</p>}
                            <div className="mt-3 flex items-center justify-between text-sm text-gray-500">
                              <span>â†’ Watch on YouTube</span>
                            </div>
                          </div>
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                {/* AI-Recommended Resources */}
                {resources.resources && resources.resources.length > 0 && (
                  <div>
                    <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                      <FileText className="w-5 h-5 text-purple-600" />
                      Recommended Resources
                    </h3>
                    <div className="space-y-3">
                      {resources.resources.map((resource, idx) => (
                        <div key={idx} className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                          <div className="flex justify-between items-start gap-4">
                            <div className="flex-1">
                              <h4 className="font-bold text-gray-900">{resource.title}</h4>
                              <p className="text-sm text-gray-600 mt-2">{resource.description}</p>
                              <div className="mt-3 flex gap-2 flex-wrap">
                                {resource.tags && resource.tags.map((tag, tidx) => (
                                  <span key={tidx} className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">
                                    {tag}
                                  </span>
                                ))}
                              </div>
                            </div>
                            {resource.url && (
                              <a
                                href={resource.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm whitespace-nowrap"
                              >
                                Access â†’
                              </a>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {!resources.videos?.length && !resources.resources?.length && (
                  <div className="bg-white rounded-lg p-12 text-center text-gray-500">
                    <AlertCircle className="w-12 h-12 mx-auto mb-3 opacity-30" />
                    <p>No resources found. Check the study plan tab for guidance.</p>
                  </div>
                )}
              </div>
            ) : (
              <div className="bg-white rounded-lg p-12 text-center text-gray-500">
                <FileText className="w-12 h-12 mx-auto mb-3 opacity-30" />
                <p>Select a task to see resources</p>
              </div>
            )}
          </div>
        )}

        {/* Study Plan Tab */}
        {activeTab === 'plan' && (
          <div>
            {loadingResources ? (
              <LoadingSpinner />
            ) : studyPlan ? (
              <div className="space-y-8">
                {/* Selected Task Info */}
                {selectedTask && (
                  <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border border-blue-200">
                    <h3 className="font-bold text-gray-900 text-lg">{selectedTask.title}</h3>
                    <p className="text-gray-600 mt-2">{selectedTask.description}</p>
                    <div className="mt-4 flex gap-4 text-sm">
                      <span className="px-3 py-1 bg-white rounded border border-gray-200">
                        <strong>Type:</strong> {selectedTask.type}
                      </span>
                      <span className="px-3 py-1 bg-white rounded border border-gray-200">
                        <strong>Days left:</strong> {selectedTask.daysLeft}
                      </span>
                    </div>
                  </div>
                )}

                {/* Study Overview */}
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="bg-white rounded-lg p-6 border-l-4 border-blue-500">
                    <p className="text-sm text-gray-600">Total Study Hours</p>
                    <p className="text-3xl font-bold text-blue-600 mt-2">{studyPlan.totalHours}</p>
                  </div>
                  <div className="bg-white rounded-lg p-6 border-l-4 border-green-500">
                    <p className="text-sm text-gray-600">Daily Average</p>
                    <p className="text-3xl font-bold text-green-600 mt-2">
                      {(studyPlan.totalHours / studyPlan.totalDays).toFixed(1)}h
                    </p>
                  </div>
                </div>

                {/* Daily Schedule */}
                <div>
                  <h4 className="font-bold text-gray-900 mb-4">Daily Breakdown</h4>
                  <div className="space-y-3">
                    {studyPlan.dailySchedule.map((day) => (
                      <div key={day.day} className="bg-white rounded-lg p-4 border border-gray-200">
                        <div className="flex justify-between items-center mb-2">
                          <h5 className="font-bold text-gray-900">Day {day.day}: {day.focus}</h5>
                          <span className="text-sm font-medium text-gray-600">{Math.ceil(day.totalMinutes / 60)}h</span>
                        </div>
                        <ul className="space-y-1 text-sm text-gray-600">
                          {day.tasks && day.tasks.map((task, idx) => (
                            <li key={idx} className="flex items-start gap-2">
                              <CheckCircle className="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" />
                              <span>{task.description} ({task.duration}min)</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Smart Tips */}
                <div>
                  <h4 className="font-bold text-gray-900 mb-4">Smart Tips</h4>
                  <div className="space-y-2">
                    {studyPlan.smartTips && studyPlan.smartTips.map((tip, idx) => (
                      <div key={idx} className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex items-start gap-3">
                        <span className="text-lg">ðŸ’¡</span>
                        <p className="text-gray-700">{tip}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Prediction */}
                {studyPlan.estimatedScore && (
                  <div className="grid md:grid-cols-2 gap-4">
                    <div className="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-lg p-6">
                      <p className="text-sm text-green-700 font-medium">Estimated Score</p>
                      <p className="text-4xl font-bold text-green-700 mt-2">{Math.round(studyPlan.estimatedScore)}%</p>
                      <p className="text-sm text-green-600 mt-2">if you follow this plan</p>
                    </div>
                    <div className="bg-gradient-to-br from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-6">
                      <p className="text-sm text-blue-700 font-medium">Readiness Level</p>
                      <p className="text-2xl font-bold text-blue-700 mt-2">{studyPlan.confidenceLevel || 'High'}</p>
                      <p className="text-sm text-blue-600 mt-2">Based on task complexity</p>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <div className="bg-white rounded-lg p-12 text-center text-gray-500">
                <Target className="w-12 h-12 mx-auto mb-3 opacity-30" />
                <p>Select a task and wait for the study plan to load</p>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default StudyHelperPage;
